name: Android Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "Semantic version name (e.g. 1.28.2)"
        required: true
      version_code:
        description: "Monotonic version code (e.g. 4396)"
        required: true
      create_tag:
        description: "Create Git tag v<version_name>"
        required: false
        default: "true"
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

env:
  JAVA_VERSION: "17"
  ANDROID_API_LEVEL: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  SIGNING_KEYSTORE_PATH: "app/signing/release.keystore"

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container: ghcr.io/syncthing/syncthing-android-builder

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --system --add safe.directory '*'

      - name: Determine version metadata
        id: version
        run: |
          VERSION_NAME_INPUT="${{ github.event.inputs.version_name }}"
          VERSION_CODE_INPUT="${{ github.event.inputs.version_code }}"

          if [ -n "$VERSION_NAME_INPUT" ]; then
            VERSION_NAME="$VERSION_NAME_INPUT"
          else
            VERSION_NAME="${GITHUB_REF_NAME#v}"
          fi

          if [ -z "$VERSION_NAME" ]; then
            VERSION_NAME="$(grep 'versionName = ' app/build.gradle.kts | cut -d'"' -f2)"
          fi

          if [ -n "$VERSION_CODE_INPUT" ]; then
            VERSION_CODE="$VERSION_CODE_INPUT"
          else
            VERSION_CODE="$(grep 'versionCode = ' app/build.gradle.kts | awk '{print $3}')"
          fi

          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ]; then
            echo "Unable to determine version metadata." >&2
            exit 1
          fi

          echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "version_tag=v$VERSION_NAME" >> "$GITHUB_OUTPUT"

      - name: Prepare signing keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Generating self-signed keystore for personal use..."
            mkdir -p "$(dirname "${SIGNING_KEYSTORE_PATH}")"
            keytool -genkeypair \
              -keystore "${SIGNING_KEYSTORE_PATH}" \
              -alias android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Personal Fork, OU=Personal, O=Personal, L=Personal, ST=Personal, C=US"
            echo "ANDROID_KEY_ALIAS=android" >> "$GITHUB_ENV"
            echo "ANDROID_KEYSTORE_PASSWORD=android" >> "$GITHUB_ENV"
            echo "ANDROID_KEY_PASSWORD=android" >> "$GITHUB_ENV"
          else
            echo "Using provided keystore from secrets..."
            mkdir -p "$(dirname "${SIGNING_KEYSTORE_PATH}")"
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "${SIGNING_KEYSTORE_PATH}"
            echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> "$GITHUB_ENV"
            echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> "$GITHUB_ENV"
            echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> "$GITHUB_ENV"
          fi
          echo "ANDROID_KEYSTORE_PATH=${GITHUB_WORKSPACE}/${SIGNING_KEYSTORE_PATH}" >> "$GITHUB_ENV"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build native libraries
        run: |
          java -version
          ./gradlew --no-daemon buildNative

      - name: Run lint
        run: ./gradlew --no-daemon lint

      - name: Assemble release artifacts
        env:
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
          SYNCTHING_RELEASE_STORE_FILE: ${{ env.ANDROID_KEYSTORE_PATH }}
          SYNCTHING_RELEASE_KEY_ALIAS: ${{ env.ANDROID_KEY_ALIAS }}
          SIGNING_PASSWORD: ${{ env.ANDROID_KEYSTORE_PASSWORD }}
        run: |
          ./gradlew --stacktrace --no-daemon assembleRelease

      - name: Generate checksums
        run: |
          cd app/build/outputs/apk/release
          sha256sum app-release.apk > sha256sum.txt
          cat sha256sum.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ github.sha }}
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/apk/release/sha256sum.txt

      - name: Create Git tag
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true'
        uses: actions/github-script@v7
        env:
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        with:
          script: |
            const tag = process.env.VERSION_TAG;
            if (!tag) {
              core.setFailed('VERSION_TAG was not provided');
              return;
            }

            const { repo, owner } = context.repo;
            const sha = context.sha;

            try {
              await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${tag}`, sha });
            } catch (error) {
              if (error.status === 422) {
                core.notice(`Tag ${tag} already exists; skipping creation.`);
                return;
              }

              core.setFailed(`Unable to create tag ${tag}: ${error.message}`);
            }

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true')
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.version_tag }}
          tag_name: ${{ steps.version.outputs.version_tag }}
          body: |
            ## Syncthing Android Fork - Release ${{ steps.version.outputs.version_name }}
            
            **Version**: ${{ steps.version.outputs.version_name }} (Build ${{ steps.version.outputs.version_code }})
            **Build Date**: ${{ github.event.head_commit.timestamp }}
            **Commit**: ${{ github.sha }}
            
            ### Installation Instructions
            
            1. Download the `app-release.apk` file
            2. Enable "Install from Unknown Sources" on your Android device
            3. Install the APK
            4. Verify the SHA256 checksum matches the one in `sha256sum.txt`
            
            ### Notes
            
            - This is a **self-signed** APK for personal use
            - You may need to uninstall previous versions first
            - The app package is `com.nutomic.syncthingandroid`
            
            ### What's Changed
            
            See commit history for details: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/apk/release/sha256sum.txt
